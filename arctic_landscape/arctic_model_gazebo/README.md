
# Troubleshooting

## TF frames of the robot in RViz not loading / Wheel or camera controllers don't work
Usually happens when Gazebo takes too long to load and the controller spawner is tired
of waiting and gives up on loading the controllers. Some frames (base_link and other
static ones) will be fixed automatically after 5-10 minutes of waiting when the model
will be finally fully loaded. Other frames (camera and wheels) that are connected
to active joints require the controllers to be spawned. To spawn them manually, wait
for the Gazebo model to fully load, then launch them separately using the command:

```
roslaunch arctic_model_gazebo spawn_robot_controllers.launch
```

# Генерация выборок

Скрипт gen_images_set.py предназначен для создания выборки изображений объектов мира робота, снятых с разных ракурсов и расстояний, для обучения систем автоматического распознавания. Сбор выборки запускается командой "roslaunch arctic_model_gazebo arctic_static_camera.launch", которая, помимо gen_images_set.py, запускает симуляцию пустого мира с управляемой видеокамерой. Собранные изображения и сведения о положении объектов на них собираются в указанную директорию.

## 0) Требования к ПО для создания выборки

Помимо обычных модулей ROS и gazebo, позволяющих запускать моделирование виртуального окружения, требуется установить модуль для работы с трёхмерными моделями объектов pycollada. Из-за обнаруженных багов этого модуля, мешающих корректной загрузке некоторых файлов моделей, рекомендуется использовать вместо устанавливаемой по умолчанию версии 0.7.1 версию 0.6:

```
pip install pycollada==0.6
```

## 1) Настройка камеры для получения изображений

Файл с моделью камеры static_camera.xacro находится в директории arctic_landscape/src/arctic_model/arctic_model_description/urdf/. Для настройки вида с камеры могут использоваться следующие параметры:

- width, height (строки 43,44): размеры изображения в пикселях;

- horizontal_fov (строка 41): угловой размер поля зрения камеры, рад;

- clip near, far (строки 48,49): ближняя и дальняя дистанции отсечения (в поле зрения попадают только объекты внутри указанного диапазона дистанций).

## 2) Настройка позиций камеры для съёмки

В процессе работы скрипта камера автоматически перемещается вокруг каждого объекта карты, делая указанное количество снимков. В текущей версии съёмка каждого объекта происходит одинаковым образом, то есть независимо от его вида и окружения, в том числе без учёта других объектов, которые могут загородить снимаемый; это делает необходимым дополнительное ручное отбрасывание некачественных изображений.

Съёмка объекта ведётся в один или несколько круговых обходов. Каждый обход задаётся:

- distance --- расстоянием от центра объекта до окружности, по которой осуществляется обход, в метрах;

- height --- высотой оптического центра камеры относительно нижнего края объекта в метрах;

- images_number --- количеством изображений, которое будет получено при обходе; количество точки съёмки располагаются равномерно по окружности обхода, причём камера каждый раз направлена на объект;

- start_angle --- азимутом, на котором будет находиться относительно объекта первая точка съёмки (в градусах).

Например, при съёмке объекта, находящегося в точке с координатами (0,0,0), при distance=2, height=1, images_number=4 и start_angle=0, точки съёмки будут располагаться в координатах (2,0,1), (0,2,1), (-2,0,1), (0,-2,1), то есть с востока, севера, запада и юга от объекта. При start_angle=45 эти точки сместятся на 45 градусов против часовой стрелки. 

Центр камеры при съёмке всегда направлен на объект; при этом объект может помещаться в кадре не полностью.

Вид обходов задаётся файлом формата JSON, расположенным по умолчанию в arctic_landscape/src/arctic_model/arctic_model_gazebo/config/get_images_config.json. Описанная в нём переменная movement_configuration --- список, каждый элемент которого описывает один обход.

## 3) Настройка launch-файла:

Файл запуска сбора данных arctic_static_camera.launch находится в директории arctic_landscape/src/arctic_model/arctic_model_gazebo/launch/. Доступны следующие настройки:

- output_dir --- директория для сбора результатов (изображений и файла их описания). По умолчанию arctic_landscape/src/arctic_model/arctic_model_gazebo/images;

- world_file --- описание модельного мира, съёмку которого надо проводить. По умолчанию arctic_landscape/src/arctic_model/arctic_model_gazebo/worlds/arctic3.world;

- model_library --- путь к используемой библиотеке 3D-моделей; по умолчанию arctic_landscape/models/;

- imaging_settings --- путь к файлу настроек позиций камеры при съёмке; по умолчанию arctic_landscape/src/arctic_model/arctic_model_gazebo/config/get_images_config.json;

- use_cache_file --- использовать ли кэширование результатов обработки 3D-моделей модулем pycollada; при нестабильной работе этого модуля (при множестве сообщений об ошибках обработки) рекомендуется использовать значение True; по умолчанию False;

- draw_debug_rects --- обводить ли места на изображениях, в которых располагаются объекты, красными контурными прямоугольниками для удобной проверки качества изображений, или нет. По умолчанию False.

## 4) Выходные данные

После запуска скрипта и обработки всех объектов в директории результатов должны появиться полученные изображения и файл с их описанием. Файл имеет формат csv со следующими полями:

- model_name --- имя снимаемой модели, уникальное в пределах виртуального мира;

- model_type --- тип снимаемой модели;

- image_number --- номер изображения снимаемой модели;

- distance --- расстояние до модели при съёмке, м;

- angle --- азимут точки съемки относительно оси OX, рад;

- height --- высота точки съёмки относительно нижней части объекта, м;

- top --- верхняя граница прямоугольника, занимаемого объектом на изображении, в пикселях (отсчёт ведётся сверху вниз);

- bottom --- нижняя граница прямоугольника объекта;

- left --- левая граница прямоугольника объекта;

- right --- правая граница прямоугольника объекта;

- filename --- имя файла изображения.

Имена сгенерированных файлов начинаются с числовой последовательности, задающей момент начала моделирования (год-месяц-день-час-минута-секунда).

В случае, если камера не смогла занять предписанную позицию, вместо имени файла в соответствующей графе выводится текст "image was not taken because of obstacles"